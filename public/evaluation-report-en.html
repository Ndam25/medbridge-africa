<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MedBridge Africa ‚Äî EB-1A / EB-2 NIW Pre-Evaluation Report</title>
  <style>
    body{font-family:Inter,Arial,Helvetica,sans-serif;background:#f8fafc;color:#0f172a;margin:0}
    main{max-width:900px;margin:24px auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between}
    h1{color:#0f766e;margin:6px 0}
    .card{background:#fff;border:1px solid #e6eef2;padding:18px;border-radius:10px;margin-top:12px}
    .muted{color:#64748b}
    .metrics li{margin:6px 0}
    .actions{margin-top:14px;display:flex;gap:10px}
    button{background:#0f766e;color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    a.btn-link{color:#0f766e;text-decoration:none;font-weight:600}
  </style>
</head>
<body>
  <main>
    <header>
      <div>
        <h1>EB-1A / EB-2 NIW Pre-Evaluation Report</h1>
        <div class="muted">EB-1A / EB-2 NIW pre-assessment by MedBridge Africa ‚Äî a strategic guidance tool (informational only).</div>
      </div>
      <div id="score-badge" style="text-align:right">
        <div id="score-line" style="font-weight:800;font-size:20px">70 / 100</div>
        <div id="program-guess" class="muted">Indicative example</div>
      </div>
    </header>

    <section class="card">
      <h2>Quick interpretation</h2>
      <p id="band-text">Quick interpretation based on a sample profile. The actual report will automatically update based on your answers.</p>
    </section>

    <section class="card">
      <h2>Profile summary</h2>
      <p id="profile-summary">Example: African healthcare professional or researcher, with a career path still being developed.</p>
      <p id="profile-email" class="muted">Email: not provided ‚Ä¢ This report is indicative and should be reviewed with a MedBridge Africa advisor.</p>
    </section>

    <section class="card">
      <h2>Academic & professional indicators</h2>
      <ul id="metrics-list" class="metrics">
        <li>Publications: example (0 entered)</li>
        <li>Citations: example (0)</li>
        <li>Awards/distinctions: example (not specified)</li>
      </ul>
    </section>

    <section class="card">
      <h2>Project and proposed impact</h2>
      <p id="project-text">Example: Project currently being described. The final report will include your answers regarding the sector, location, and anticipated impact in the United States.</p>
    </section>

    <section class="card">
      <h2>Main recommendations</h2>
      <ul id="reco-list">
        <li>Consolidate recommendation letters (US if possible).</li>
        <li>Document national impact and alignment with US priorities (public health, innovation, AI, underserved populations).</li>
        <li>Plan 12‚Äì18 months of strategic publications and communications before submitting the application.</li>
      </ul>
    </section>

    <div style="margin-top:14px;display:flex;justify-content:space-between;align-items:center">
      <a id="return-link" class="btn-link" href="evaluation-form-en.html">‚Üê Return to the form</a>

      <div class="actions">
        <button id="download-pdf">üìÑ Download this report (PDF)</button>
        <button id="send-email">‚úâÔ∏è Send this report by email</button>
      </div>
    </div>

    <p id="placeholder-note" class="muted" style="margin-top:12px">No data found in the browser (default example displayed).</p>

    <footer style="margin-top:20px;color:#64748b;font-size:0.9rem">
      Next step with MedBridge Africa ‚Äî book a call, chat on WhatsApp, or request an expert analysis (reserved for subscribing customers).
      <div style="margin-top:8px">¬© <span id="year"></span> MedBridge Africa</div>
    </footer>
  </main>

  <script>
    (function () {
      // Utility to safely parse JSON
      function safeParse(json) {
        try { return JSON.parse(json); } catch (e) { return null; }
      }

      function renderFromData(data) {
        const scoreLine = document.getElementById("score-line");
        const programGuessEl = document.getElementById("program-guess");
        const bandTextEl = document.getElementById("band-text");
        const profileSummaryEl = document.getElementById("profile-summary");
        const profileEmailEl = document.getElementById("profile-email");
        const metricsListEl = document.getElementById("metrics-list");
        const projectTextEl = document.getElementById("project-text");
        const recoListEl = document.getElementById("reco-list");
        const placeholderNote = document.getElementById("placeholder-note");

        const score = typeof data.score === "number" ? data.score : 0;
        const programGuess = data.programGuess || "Profile under construction";
        const profile = data.profile || {};
        const metrics = data.metrics || {};
        const project = data.project || {};
        const recos = Array.isArray(data.recommendations) ? data.recommendations : [];

        // band text
        let bandLabel = "", bandDetail = "";
        if (score >= 85) {
          bandLabel = "Very solid profile for an EB-1A / EB-2 NIW case.";
          bandDetail = "You already have a strong track record; focus on strategic narrative and evidence.";
        } else if (score >= 70) {
          bandLabel = "Good potential for an EB-2 NIW; EB-1A possible with strengthening.";
          bandDetail = "Targeted work on impact, leadership and visibility recommended.";
        } else if (score >= 55) {
          bandLabel = "Profile on the right track for EB-2 NIW with further work.";
          bandDetail = "Plan concrete actions (publications, collaborations, U.S. project) over 12‚Äì24 months.";
        } else {
          bandLabel = "Profile early for EB-1A/EB-2 NIW.";
          bandDetail = "Prioritize building publications, distinctions and high-impact responsibilities.";
        }

        if (scoreLine) scoreLine.textContent = `${score} / 100`;
        if (programGuessEl) programGuessEl.textContent = programGuess;
        if (bandTextEl) bandTextEl.textContent = `${bandLabel} ${bandDetail}`;

        // Profile (align with form payload keys)
        const name = profile.fullName || "Candidate";
        const email = profile.email || "";
        const country = profile.country || "Country not specified";
        const education = profile.educationLevel || "Education level not specified";
        const years = typeof profile.yearsExperience === "number" ? profile.yearsExperience : null;
        const summary = profile.summary || "";
        const targetProgram = profile.targetProgram || "";

        let profileText = `${name} is considering a skilled immigration strategy ${targetProgram ? "(" + targetProgram + ")" : ""} with an academic level of ${education.toLowerCase()}.`;
        if (years !== null) profileText += ` Post-graduate experience: approximately ${years} year(s).`;
        profileText += ` Main country / professional context: ${country}.`;
        if (summary && summary.trim().length > 0) profileText += `\n\nBackground summary: ${summary}`;

        if (profileSummaryEl) profileSummaryEl.textContent = profileText;
        if (profileEmailEl) profileEmailEl.textContent = email ? `Email: ${email} ‚Ä¢ This report is indicative and should be reviewed with a MedBridge Africa advisor.` : `Email: not provided ‚Ä¢ This report is indicative and should be reviewed with a MedBridge Africa advisor.`;

        // Metrics
        if (metricsListEl) {
          metricsListEl.innerHTML = "";
          const pubs = metrics.pubs ?? 0;
          const cites = metrics.cites ?? 0;
          const awards = metrics.awards ?? 0;

          const liP = document.createElement("li");
          liP.textContent = `Publications: ${pubs} (${pubs > 0 ? "documented" : "no publications recorded ‚Äî consider increasing indexed outputs."})`;
          metricsListEl.appendChild(liP);

          const liC = document.createElement("li");
          liC.textContent = `Citations: ${cites} (${cites > 0 ? "bibliometric impact noted" : "no citation data recorded."})`;
          metricsListEl.appendChild(liC);

          const liA = document.createElement("li");
          liA.textContent = awards ? `Awards/distinctions: ${awards} (document and describe the context).` : "Awards/distinctions: none recorded (opportunity to strengthen).";
          metricsListEl.appendChild(liA);
        }

        // Project
        if (projectTextEl) {
          if (project.summary && project.summary.trim().length > 0) {
            projectTextEl.textContent = `Sector: ${project.sector || "not specified"}. Target place/context: ${project.place || "not specified"}.\n\nProject summary: ${project.summary}`;
          } else {
            projectTextEl.textContent = "Your project is not yet described in detail in the form. Please specify the sector, place, and expected impacts in the United States.";
          }
        }

        // Recommendations
        if (recoListEl) {
          recoListEl.innerHTML = "";
          if (recos.length > 0) {
            recos.forEach(r => {
              const li = document.createElement("li");
              li.textContent = r;
              recoListEl.appendChild(li);
            });
          } else {
            const defaultRecos = [
              "Consolidate recommendation letters (US if possible).",
              "Document national impact and alignment with US priorities (public health, innovation, AI, underserved populations).",
              "Plan 12‚Äì18 months of strategic publications and communications before submitting the application."
            ];
            defaultRecos.forEach(r => {
              const li = document.createElement("li");
              li.textContent = r;
              recoListEl.appendChild(li);
            });
          }
        }

        if (placeholderNote) placeholderNote.textContent = "Data loaded from the browser. Personalized report displayed.";
      }

      // On load: read localStorage
      document.addEventListener("DOMContentLoaded", function () {
        const yearSpan = document.getElementById("year");
        if (yearSpan) yearSpan.textContent = new Date().getFullYear();

        let raw = null;
        try { raw = localStorage.getItem("mba_eval_result_v1"); } catch (e) { console.warn("localStorage read error", e); }

        if (!raw) {
          // nothing saved ‚Äî keep default sample
          return;
        }

        const data = safeParse(raw);
        if (!data) return;

        renderFromData(data);
      });

      // Send report by email via Netlify function (expects JSON body)
      document.getElementById("send-email").addEventListener("click", function () {
        let raw = null;
        try { raw = localStorage.getItem("mba_eval_result_v1"); } catch (e) { raw = null; }
        if (!raw) {
          alert("No report data to send. Please complete the form first.");
          return;
        }
        fetch("/.netlify/functions/send-mail", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: raw
        }).then(res => res.json().catch(()=>({})))
          .then(()=> alert("Report sent ‚Äî check your inbox."))
          .catch(err => { console.error(err); alert("Unable to send email at this time."); });
      });

      // Basic PDF download ‚Äî use browser print to PDF as fallback
      document.getElementById("download-pdf").addEventListener("click", function () {
        window.print();
      });
    })();
  </script>
</body>
</html>
